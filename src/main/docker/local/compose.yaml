version: '3.9'
services:
  jms:
    image: vromero/activemq-artemis
    ports:
      - "8161:8161"
      - "61616:61616"
  zipkin:
    image: openzipkin/zipkin
    ports:
      - "9411:9411"
  eureka:
    image: dcividin/mssc-brewery-eureka:1.0.4
    ports:
      - "8761:8761"
#    healthcheck:
#      test: "curl --fail --silent netflix:eureka@localhost:8761/actuator/health | grep UP || exit 1"
#      interval: 2s
#      timeout: 3s
#      retries: 5
  config-service:
    image: dcividin/mssc-config-server:1.0.4
    ports:
      - "8888:8888"
#    depends_on:
#      eureka:
#        condition: service_healthy
    depends_on:
      - eureka
    environment:
      SERVICE_EUREKA_URL_DEFAULT_ZONE_WKA: http://netflix:eureka@eureka:8761/eureka
      MANAGEMENT_ZIPKIN_TRACING_ENDPOINT: http://zipkin:9411/api/v2/spans
      LOGGING_LEVEL_ORG_SPRINGFRAMEWORK_CLOUD: INFO
      LOGGING_LEVEL_ORG_SPRINGFRAMEWORK_WEB: INFO
#    healthcheck:
#      test: "curl --fail --silent localhost:8888/actuator/health | grep UP || exit 1"
#      interval: 2s
#      timeout: 3s
#      retries: 5
#      start_period: 1s
  inventory-service:
    image: dcividin/mssc-beer-inventory-service:1.0.5
    ports:
      - "8082:8082"
    depends_on:
      - eureka
      - config-service
      - jms
#      - gateway-service
#      - inventory-failover-service
    environment:
      SERVICE_EUREKA_URL_DEFAULT_ZONE_WKA: http://netflix:eureka@eureka:8761/eureka
      SPRING_PROFILES_ACTIVE: cloud-local,localmysql
      SPRING_ARTEMIS_HOST: jms
#      SPRING_CONFIG_ENABLED: true
#      SPRING_CONFIG_IMPORT: "optional:configserver:http://config-service:8888"
#      SPRING_CLOUD_CONFIG_USERNAME: MyUserName
#      SPRING_CLOUD_CONFIG_PASSWORD: MySecretPassword
#      SPRING_CLOUD_CONFIG_DISCOVERY_ENABLED: true
#      SPRING_CLOUD_CONFIG_IMPORTCHECK_ENABLED: true
#      SPRING_CLOUD_CONFIG_FAILFAST: true
#      SPRING_CLOUD_CONFIG_RETRY_MAXATTEMPTS: 30
#      SPRING_CLOUD_CONFIG_RETRY_MAXINTERVAL: 5000
#      SPRING_CLOUD_CONFIG_RETRY_MULTIPLIER: 1.2
#      SPRING_CLOUD_CONFIG_RETRY_INITIALINTERVAL: 2000
      MANAGEMENT_ZIPKIN_TRACING_ENDPOINT: http://zipkin:9411/api/v2/spans
      SPRING_DATASOURCE_URL: jdbc:mysql://host.docker.internal:3306/beerinventoryservice?useUnicode=true&characterEncoding=UTF-8&serverTimezone=UTC
  inventory-failover-service:
    image: dcividin/mssc-beer-failover-inventory-service:1.0.5
    ports:
      - "8083:8083"
    depends_on:
      - eureka
      - config-service
    environment:
      SERVICE_EUREKA_URL_DEFAULT_ZONE_WKA: http://netflix:eureka@eureka:8761/eureka
  beer_service:
    image: dcividin/mssc-beer-service:1.0.5
    ports:
      - "8080:8080"
    depends_on:
      - eureka
      - config-service
      - jms
#      - gateway-service
      - inventory-service
    environment:
      SERVICE_EUREKA_URL_DEFAULT_ZONE_WKA: http://netflix:eureka@eureka:8761/eureka
      SPRING_PROFILES_ACTIVE: cloud-local,localmysql
      SPRING_ARTEMIS_HOST: jms
      SFG_BREWERY_BEERINVENTORYSERVICEHOST: http://inventory-service:8082
      SFG_BREWERY_INVENTORYUSER: good
      SFG_BREWERY_INVENTORYPASSWORD: beer
#      SPRING_CONFIG_ENABLED: true
#      SPRING_CONFIG_IMPORT: "optional:configserver:http://config-service:8888"
#      SPRING_CLOUD_CONFIG_USERNAME: MyUserName
#      SPRING_CLOUD_CONFIG_PASSWORD: MySecretPassword
#      SPRING_CLOUD_CONFIG_DISCOVERY_ENABLED: true
#      SPRING_CLOUD_CONFIG_IMPORTCHECK_ENABLED: true
#      SPRING_CLOUD_CONFIG_FAILFAST: true
#      SPRING_CLOUD_CONFIG_RETRY_MAXATTEMPTS: 30
#      SPRING_CLOUD_CONFIG_RETRY_MAXINTERVAL: 5000
#      SPRING_CLOUD_CONFIG_RETRY_MULTIPLIER: 1.2
#      SPRING_CLOUD_CONFIG_RETRY_INITIALINTERVAL: 2000
#      SPRING_CLOUD_OPENFEIGN_CIRCUITBREAKER_ENABLED: true
      MANAGEMENT_ZIPKIN_TRACING_ENDPOINT: http://zipkin:9411/api/v2/spans
      SPRING_DATASOURCE_URL: jdbc:mysql://host.docker.internal:3306/beerservice?useUnicode=true&characterEncoding=UTF-8&serverTimezone=UTC
  beer_order_service:
    image: dcividin/mssc-beer-order-service:1.0.2
    ports:
      - "8081:8081"
    depends_on:
      - eureka
      - config-service
      - jms
#      - gateway-service
      - beer_service
    environment:
      SERVICE_EUREKA_URL_DEFAULT_ZONE_WKA: http://netflix:eureka@eureka:8761/eureka
      SPRING_PROFILES_ACTIVE: cloud-local,localmysql
      SPRING_ARTEMIS_HOST: jms
#      SPRING_CONFIG_ENABLED: true
#      SPRING_CONFIG_IMPORT: "optional:configserver:http://config-service:8888"
#      SPRING_CLOUD_CONFIG_USERNAME: MyUserName
#      SPRING_CLOUD_CONFIG_PASSWORD: MySecretPassword
#      SPRING_CLOUD_CONFIG_DISCOVERY_ENABLED: true
#      SPRING_CLOUD_CONFIG_IMPORTCHECK_ENABLED: true
#      SPRING_CLOUD_CONFIG_FAILFAST: true
#      SPRING_CLOUD_CONFIG_RETRY_MAXATTEMPTS: 30
#      SPRING_CLOUD_CONFIG_RETRY_MAXINTERVAL: 5000
#      SPRING_CLOUD_CONFIG_RETRY_MULTIPLIER: 1.2
#      SPRING_CLOUD_CONFIG_RETRY_INITIALINTERVAL: 2000
#      SPRING_CLOUD_OPENFEIGN_CIRCUITBREAKER_ENABLED: true
      MANAGEMENT_ZIPKIN_TRACING_ENDPOINT: http://zipkin:9411/api/v2/spans
      SPRING_DATASOURCE_URL: jdbc:mysql://host.docker.internal:3306/beerorderservice?useUnicode=true&characterEncoding=UTF-8&serverTimezone=UTC
      SFG_BREWERY_BEERSERVICEHOST: http://beer_service:8080
      SFG_BREWERY_BEERSERVICEUSER: good
      SFG_BREWERY_BEERSERVICEPASSWORD: beer
  gateway-service:
    image: dcividin/mssc-brewery-gateway:1.0.3
    ports:
      - "9090:9090"
    depends_on:
      - eureka
      - config-service
      - inventory-service
      - inventory-failover-service
      - beer_service
      - beer_order_service
    environment:
      SERVICE_EUREKA_URL_DEFAULT_ZONE_WKA: http://netflix:eureka@eureka:8761/eureka
      #      EUREKA_CLIENT_REGISTERWITHEUREKA: false
      #      EUREKA_CLIENT_FETCHREGISTRY: false
      SPRING_PROFILES_ACTIVE: local-discovery
  #      SPRING_CONFIG_ENABLED: true
  #      SPRING_CONFIG_IMPORT: "optional:configserver:http://config-service:8888"
  #      SPRING_CLOUD_CONFIG_USERNAME: MyUserName
  #      SPRING_CLOUD_CONFIG_PASSWORD: MySecretPassword
  #      SPRING_CLOUD_CONFIG_DISCOVERY_ENABLED: true
  #      SPRING_CLOUD_CONFIG_IMPORTCHECK_ENABLED: true
  #      SPRING_CLOUD_CONFIG_FAILFAST: true
  #      SPRING_CLOUD_CONFIG_RETRY_MAXATTEMPTS: 30
  #      SPRING_CLOUD_CONFIG_RETRY_MAXINTERVAL: 5000
  #      SPRING_CLOUD_CONFIG_RETRY_MULTIPLIER: 1.2
  #      SPRING_CLOUD_CONFIG_RETRY_INITIALINTERVAL: 2000